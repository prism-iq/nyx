#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#  NYXX KILLSWITCH - Actions d'Urgence
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

NYXX_HOME="$(dirname "$(realpath "$0")")"
NYXX_URL="http://127.0.0.1:8080"

C_RED='\033[38;5;203m'
C_GREEN='\033[38;5;114m'
C_FIRE='\033[38;5;208m'
C_RESET='\033[0m'

actions="ðŸ›‘ ArrÃªter Nyxx
ðŸ”„ Restart Nyxx
ðŸ§¹ Nettoyer /tmp
ðŸ“Š LibÃ©rer RAM
ðŸ’¾ Sync Disques
ðŸ”¥ Kill Processus Lourds
âš¡ Mode Ã‰conomie
ðŸš¨ URGENCE TOTALE
âŒ Annuler"

choice=$(echo -e "$actions" | rofi -dmenu -i -p "âš ï¸ KILLSWITCH" \
  -theme-str 'window {width: 350px; background-color: #1a0a0a;} element-text {color: #ff6b35;}' 2>/dev/null || \
  echo -e "$actions" | dmenu -i -p "KILLSWITCH:" 2>/dev/null)

case "$choice" in
  *"ArrÃªter"*)
    pkill -f "node src/server.js"
    notify-send "ðŸ›‘ NYXX" "ArrÃªtÃ©e" 2>/dev/null
    echo -e "${C_RED}â— Nyxx arrÃªtÃ©e${C_RESET}"
    ;;

  *"Restart"*)
    pkill -f "node src/server.js"
    sleep 1
    cd "$NYXX_HOME" && node src/server.js > /tmp/nyxx.log 2>&1 &
    notify-send "ðŸ”„ NYXX" "RedÃ©marrÃ©e" 2>/dev/null
    echo -e "${C_GREEN}â— Nyxx redÃ©marrÃ©e${C_RESET}"
    ;;

  *"Nettoyer"*)
    rm -rf /tmp/nyxx-forge/* 2>/dev/null
    rm -f /tmp/nyxx*.log 2>/dev/null
    find /tmp -name "*.pyc" -delete 2>/dev/null
    find /tmp -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null
    notify-send "ðŸ§¹ NYXX" "Nettoyage /tmp effectuÃ©" 2>/dev/null
    echo -e "${C_GREEN}â— /tmp nettoyÃ©${C_RESET}"
    ;;

  *"LibÃ©rer RAM"*)
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null 2>&1 || true
    notify-send "ðŸ“Š NYXX" "Cache RAM libÃ©rÃ©" 2>/dev/null
    echo -e "${C_GREEN}â— RAM libÃ©rÃ©e${C_RESET}"
    ;;

  *"Sync"*)
    sync
    notify-send "ðŸ’¾ NYXX" "Disques synchronisÃ©s" 2>/dev/null
    echo -e "${C_GREEN}â— Disques sync${C_RESET}"
    ;;

  *"Kill Processus"*)
    # Kill processus > 50% CPU (sauf systÃ¨me)
    ps aux --sort=-%cpu | awk 'NR>1 && $3>50 && !/Xorg|i3|pulse|dbus/' | head -5 | while read -r line; do
      pid=$(echo "$line" | awk '{print $2}')
      name=$(echo "$line" | awk '{print $11}')
      kill "$pid" 2>/dev/null && echo "Killed: $name ($pid)"
    done
    notify-send "ðŸ”¥ NYXX" "Processus lourds terminÃ©s" 2>/dev/null
    echo -e "${C_FIRE}â— Processus lourds tuÃ©s${C_RESET}"
    ;;

  *"Ã‰conomie"*)
    # RÃ©duire frÃ©quence CPU
    for gov in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
      echo "powersave" | sudo tee "$gov" > /dev/null 2>&1
    done
    # ArrÃªter services non-essentiels
    pkill -f "chromium" 2>/dev/null
    notify-send "âš¡ NYXX" "Mode Ã©conomie activÃ©" 2>/dev/null
    echo -e "${C_GREEN}â— Mode Ã©conomie${C_RESET}"
    ;;

  *"URGENCE"*)
    # URGENCE TOTALE
    pkill -f "node src/server.js"
    rm -rf /tmp/nyxx-forge/* 2>/dev/null
    sync
    echo 3 | sudo tee /proc/sys/vm/drop_caches > /dev/null 2>&1 || true
    # Kill tous les processus > 80% CPU
    ps aux --sort=-%cpu | awk 'NR>1 && $3>80 && !/Xorg|i3|pulse|dbus|systemd/' | while read -r line; do
      pid=$(echo "$line" | awk '{print $2}')
      kill -9 "$pid" 2>/dev/null
    done
    notify-send "ðŸš¨ URGENCE" "SystÃ¨me stabilisÃ©" 2>/dev/null
    echo -e "${C_RED}â— URGENCE EXÃ‰CUTÃ‰E${C_RESET}"
    ;;

  *"Annuler"*|"")
    echo "AnnulÃ©"
    ;;
esac

# Power off propre
poweroff_nyx() {
  echo "ðŸŒ™ Nyx s'Ã©teint..."
  pkill -f "node src/server.js"
  pkill -f "nyx-heartbeat"
  rm -f /tmp/nyx*.log
  echo "$(date) - Power off" >> /home/ego-bash/nyx-v2/mind.md
}
